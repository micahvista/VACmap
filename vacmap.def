Bootstrap: docker
From: ubuntu:22.04

%post
    # VACmap source ref. Keep "main" for latest branch; set to a tag/commit to pin.
    VACMAP_REF=main

    # Update and install basic dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        git \
        bzip2 \
        ca-certificates \
        curl \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # Install micromamba (pinned)
    curl -L "https://conda.anaconda.org/conda-forge/linux-64/micromamba-1.5.10-0.tar.bz2" -o /tmp/micromamba.tar.bz2
    tar -xjf /tmp/micromamba.tar.bz2 -C /tmp bin/micromamba
    install -m 755 /tmp/bin/micromamba /usr/local/bin/micromamba
    rm -rf /tmp/micromamba.tar.bz2 /tmp/bin

    # Use a fixed root prefix for reproducible paths
    export MAMBA_ROOT_PREFIX=/opt/micromamba
    
    # Clone VACmap repository
    cd /opt
    git clone --depth 1 --branch "${VACMAP_REF}" --single-branch https://github.com/micahvista/VACmap.git
    cd VACmap
    
    # Create environment from yml file and install VACmap
    micromamba create -y -n vacmap_env -f VACmap_environment.yml
    micromamba run -n vacmap_env python -m pip install --no-cache-dir .

    # Clean up package cache to reduce image size
    micromamba clean --all --yes
    rm -rf /opt/VACmap

    # Remove build-time packages not needed at runtime
    apt-get purge -y --auto-remove build-essential git
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    # Set up micromamba environment
    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export PATH="/opt/micromamba/envs/vacmap_env/bin:$PATH"

%runscript
    # Default run command
    exec vacmap "$@"

%test
    # Smoke test: verify VACmap entrypoint resolves and runs
    vacmap --help >/dev/null

%labels
    Author micahvista
    Version v1.0.0
    Description VACmap: a long-read aligner specifically designed for complex structural variation discovery
    License GPL-3.0

%help
    VACmap - a long-read aligner for complex structural variation discovery
    
    Usage examples:
    
    Map long genomic reads (samtools is required):
    singularity exec vacmap.sif vacmap -ref /ref.fasta -read /read.fasta -mode H -t 8 | samtools sort -@4 > alignments.sorted.bam
    
    Map assembly (samtools is required):
    singularity exec vacmap.sif vacmap -ref /ref.fasta -read /read.fasta -mode asm -t 8 -workdir /workdir/ --H --fakecigar | samtools sort -@4 > alignments.sorted.bam
    
    For more information:
    https://github.com/micahvista/VACmap
